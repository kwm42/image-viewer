# 图片查看器功能设计文档

## 项目概述

这是一个基于 Next.js 13+ App Router 的本地图片查看器应用，使用 File System Access API 访问本地文件，通过 `file://` 协议直接在浏览器中打开使用。

### 核心特性
- 🗂️ **文件夹浏览器**：树状目录结构，支持展开/收起
- 🖼️ **图片画廊**：网格/列表视图，支持递归显示子文件夹
- 🔍 **图片预览**：全屏弹窗，支持缩放、旋转、平移
- 🎬 **幻灯片播放**：自动播放，可配置时长和转换动画

---

## 技术栈

### 核心框架
- **Next.js 13+**：使用 App Router 模式
- **React 18**：UI 框架
- **TypeScript**：类型安全
- **Tailwind CSS**：样式系统

### UI 组件库
- **Radix UI**：无样式、可访问的 UI 原语
  - `@radix-ui/react-dialog`：图片预览弹窗
  - `@radix-ui/react-scroll-area`：滚动区域
  - `@radix-ui/react-slider`：幻灯片时长控制
  - `@radix-ui/react-select`：选择器（排序、动画）
  - `@radix-ui/react-switch`：开关（循环、随机）
  - `@radix-ui/react-collapsible`：文件夹展开/收起

### 动画和工具
- **Framer Motion**：幻灯片转换动画
- **File System Access API**：浏览器原生文件系统访问

### 构建工具
- **pnpm**：包管理器
- **Next.js Build**：静态导出（`next build && next export`）

---

## 架构设计

### 目录结构

```
image-viewer/
├── app/
│   ├── layout.tsx              # 根布局
│   ├── page.tsx                # 主页面
│   └── globals.css             # 全局样式
├── components/
│   ├── FolderTree/
│   │   ├── FolderTree.tsx      # 文件夹树组件
│   │   ├── FolderNode.tsx      # 单个文件夹节点
│   │   └── types.ts            # 类型定义
│   ├── ImageGallery/
│   │   ├── ImageGallery.tsx    # 图片画廊（网格/列表）
│   │   ├── ImageCard.tsx       # 单张图片卡片
│   │   ├── ImageGrid.tsx       # 网格视图
│   │   ├── ImageList.tsx       # 列表视图
│   │   └── ViewModeToggle.tsx  # 视图切换
│   ├── ImageViewer/
│   │   ├── ImageViewer.tsx     # 图片预览弹窗
│   │   ├── ImageControls.tsx   # 控制条（缩放、旋转）
│   │   ├── ImageNavigation.tsx # 上一张/下一张
│   │   └── ImageInfo.tsx       # 图片信息显示
│   ├── Slideshow/
│   │   ├── Slideshow.tsx       # 幻灯片播放器
│   │   ├── SlideshowSettings.tsx  # 设置面板
│   │   ├── SlideshowControls.tsx  # 播放控制
│   │   └── transitions.ts      # 转换动画配置
│   ├── Toolbar/
│   │   ├── Toolbar.tsx         # 顶部工具栏
│   │   └── ToolbarButton.tsx   # 工具栏按钮
│   └── ui/
│       ├── Button.tsx          # 通用按钮
│       ├── IconButton.tsx      # 图标按钮
│       └── Separator.tsx       # 分隔线
├── hooks/
│   ├── useFileSystem.ts        # File System Access API 封装
│   ├── useImageLoader.ts       # 图片加载管理
│   ├── useKeyboardShortcuts.ts # 键盘快捷键
│   └── useLocalStorage.ts      # 本地存储（记住设置）
├── lib/
│   ├── fileUtils.ts            # 文件处理工具
│   ├── imageUtils.ts           # 图片处理工具
│   └── constants.ts            # 常量定义
├── types/
│   └── index.ts                # 全局类型定义
├── docs/
│   └── 功能设计文档.md          # 本文档
└── styles/
    └── globals.css             # 全局 CSS
```

---

## 核心功能模块

### 1. 文件夹浏览器 (FolderTree)

#### 功能需求
- ✅ 树状结构显示文件夹层级关系
- ✅ 点击文件夹展开/收起子文件夹
- ✅ 显示每个文件夹内的图片数量
- ✅ 高亮显示当前选中的文件夹
- ✅ 支持键盘导航（上下键切换，Enter 展开）
- ✅ 支持递归扫描子文件夹
- ✅ 懒加载子文件夹（按需展开时加载）

#### 数据结构

```typescript
interface FolderNode {
  id: string;                    // 唯一标识
  name: string;                  // 文件夹名称
  handle: FileSystemDirectoryHandle;  // 文件系统句柄
  path: string;                  // 相对路径
  children: FolderNode[];        // 子文件夹
  imageCount: number;            // 图片数量
  totalImageCount: number;       // 包含子文件夹的总图片数
  isExpanded: boolean;           // 是否展开
  isLoaded: boolean;             // 子文件夹是否已加载
  level: number;                 // 层级深度
}
```

#### 组件接口

```typescript
interface FolderTreeProps {
  rootFolder: FolderNode | null;
  selectedFolder: FolderNode | null;
  onFolderSelect: (folder: FolderNode) => void;
  onFolderToggle: (folder: FolderNode) => void;
}

interface FolderNodeProps {
  folder: FolderNode;
  isSelected: boolean;
  onSelect: () => void;
  onToggle: () => void;
  level: number;
}
```

#### UI 设计
- 使用 Radix UI `Collapsible` 实现展开/收起动画
- 使用 `ChevronRightIcon` 指示展开状态（展开时向下旋转）
- 使用 `FolderIcon`/`FolderOpenIcon` 区分状态
- 缩进层级：每层 `padding-left: 1rem`
- 悬停效果：`hover:bg-gray-100 dark:hover:bg-gray-800`
- 选中效果：`bg-blue-100 dark:bg-blue-900`

---

### 2. 图片画廊 (ImageGallery)

#### 功能需求
- ✅ **网格视图**（默认）：响应式瓦片布局
- ✅ **列表视图**：显示详细信息（文件名、大小、尺寸、日期）
- ✅ **递归显示**：可选择显示子文件夹图片或仅当前文件夹
- ✅ **懒加载**：使用 Intersection Observer 滚动加载
- ✅ **虚拟滚动**：处理大量图片时优化性能
- ✅ **排序选项**：按名称、日期、大小、类型排序
- ✅ **过滤功能**：按文件名搜索
- ✅ **多选模式**：支持批量操作（未来扩展）

#### 数据结构

```typescript
interface ImageFile {
  id: string;                    // 唯一标识
  name: string;                  // 文件名
  handle: FileSystemFileHandle;  // 文件句柄
  path: string;                  // 相对路径
  blob: Blob | null;             // 文件数据
  url: string;                   // Object URL
  thumbnail: string;             // 缩略图 URL
  size: number;                  // 文件大小（字节）
  width: number;                 // 图片宽度
  height: number;                // 图片高度
  type: string;                  // MIME 类型
  createdAt: Date;               // 创建时间
  modifiedAt: Date;              // 修改时间
  folderPath: string;            // 所属文件夹路径
}

type ViewMode = 'grid' | 'list';
type SortBy = 'name' | 'date' | 'size' | 'type';
type SortOrder = 'asc' | 'desc';

interface GallerySettings {
  viewMode: ViewMode;
  sortBy: SortBy;
  sortOrder: SortOrder;
  recursive: boolean;
  gridColumns: number;           // 2 | 3 | 4 | 6
}
```

#### 组件接口

```typescript
interface ImageGalleryProps {
  images: ImageFile[];
  settings: GallerySettings;
  onImageClick: (image: ImageFile, index: number) => void;
  onSettingsChange: (settings: Partial<GallerySettings>) => void;
}

interface ImageCardProps {
  image: ImageFile;
  viewMode: ViewMode;
  onClick: () => void;
  isSelected?: boolean;
}
```

#### 网格视图设计
```css
/* 响应式网格布局 */
.image-grid {
  display: grid;
  gap: 1rem;
  
  /* 2 列 */
  grid-template-columns: repeat(2, 1fr);
  
  /* 3 列 - 平板 */
  @media (min-width: 768px) {
    grid-template-columns: repeat(3, 1fr);
  }
  
  /* 4 列 - 桌面 */
  @media (min-width: 1024px) {
    grid-template-columns: repeat(4, 1fr);
  }
  
  /* 6 列 - 大屏 */
  @media (min-width: 1536px) {
    grid-template-columns: repeat(6, 1fr);
  }
}

/* 图片卡片 */
.image-card {
  aspect-ratio: 1 / 1;
  overflow: hidden;
  border-radius: 0.5rem;
  cursor: pointer;
  transition: transform 0.2s;
}

.image-card:hover {
  transform: scale(1.05);
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
}
```

#### 列表视图设计
- 每行显示：缩略图 | 文件名 | 尺寸 | 大小 | 修改日期
- 可点击列标题排序
- 斑马纹背景（奇偶行不同颜色）

---

### 3. 图片预览器 (ImageViewer)

#### 功能需求
- ✅ **全屏弹窗**：使用 Radix Dialog 实现
- ✅ **缩放模式**：
  - 适应窗口（Fit to Window）
  - 填充窗口（Fill Window）
  - 实际大小（Actual Size）
  - 自定义缩放（Custom Zoom：10% - 500%）
- ✅ **缩放控制**：
  - 放大（Zoom In）：每次 25%
  - 缩小（Zoom Out）：每次 25%
  - 重置（Reset）：回到适应窗口
- ✅ **平移**：缩放时可拖拽平移
- ✅ **旋转**：90° 增量旋转（0°, 90°, 180°, 270°）
- ✅ **导航**：上一张/下一张，循环切换
- ✅ **信息显示**：文件名、尺寸、大小、当前索引
- ✅ **键盘快捷键**：完整支持
- ✅ **触控支持**：双指缩放、拖拽平移（移动端）

#### 数据结构

```typescript
type FitMode = 'contain' | 'cover' | 'actual' | 'custom';

interface ImageTransform {
  scale: number;                 // 缩放比例 (0.1 - 5.0)
  rotation: number;              // 旋转角度 (0, 90, 180, 270)
  translateX: number;            // X 轴平移（像素）
  translateY: number;            // Y 轴平移（像素）
  fitMode: FitMode;              // 缩放模式
}

interface ImageViewerState {
  isOpen: boolean;
  currentImage: ImageFile | null;
  currentIndex: number;
  images: ImageFile[];
  transform: ImageTransform;
  isLoading: boolean;
}
```

#### 组件接口

```typescript
interface ImageViewerProps {
  isOpen: boolean;
  image: ImageFile;
  images: ImageFile[];
  currentIndex: number;
  onClose: () => void;
  onNavigate: (direction: 'prev' | 'next') => void;
}

interface ImageControlsProps {
  transform: ImageTransform;
  onZoomIn: () => void;
  onZoomOut: () => void;
  onReset: () => void;
  onRotate: () => void;
  onFitModeChange: (mode: FitMode) => void;
}
```

#### UI 布局

```
┌─────────────────────────────────────────────────┐
│  [关闭 X]                            1 / 42     │
│                                                 │
│                                                 │
│                                                 │
│                   [图片显示区域]                  │
│                                                 │
│                                                 │
│  [◀ 上一张]                      [下一张 ▶]      │
│                                                 │
│  ┌──────────────────────────────────────────┐  │
│  │ 📷 photo.jpg | 1920×1080 | 2.3 MB        │  │
│  │ [−] 100% [+] [↻] [适应窗口 ▾]            │  │
│  └──────────────────────────────────────────┘  │
└─────────────────────────────────────────────────┘
```

#### 控制条设计
- 浮动在图片底部
- 半透明深色背景（`backdrop-blur-md bg-black/50`）
- 左侧：图片信息
- 右侧：缩放控制按钮
- 居中：适应模式选择器

---

### 4. 幻灯片播放 (Slideshow)

#### 功能需求
- ✅ **自动播放**：按顺序自动切换图片
- ✅ **播放控制**：播放、暂停、停止
- ✅ **时长设置**：1-30 秒可调（默认 3 秒）
- ✅ **进度条**：显示当前图片剩余时间
- ✅ **转换动画**：多种过渡效果
- ✅ **播放模式**：
  - 顺序播放
  - 循环播放
  - 随机播放
- ✅ **全屏模式**：自动进入全屏
- ✅ **暂停控制**：鼠标移动时显示控制条，静止时隐藏

#### 转换动画类型

```typescript
type TransitionType = 
  | 'none'        // 无动画
  | 'fade'        // 淡入淡出
  | 'slide'       // 滑动
  | 'zoom'        // 缩放
  | 'flip'        // 翻转
  | 'cube'        // 立方体旋转
  | 'dissolve';   // 溶解

interface SlideshowSettings {
  interval: number;              // 播放间隔（毫秒）
  transition: TransitionType;    // 转换动画
  transitionDuration: number;    // 动画时长（毫秒）
  loop: boolean;                 // 循环播放
  random: boolean;               // 随机播放
  autoFullscreen: boolean;       // 自动全屏
  showInfo: boolean;             // 显示图片信息
  showProgress: boolean;         // 显示进度条
}

interface SlideshowState {
  isPlaying: boolean;
  isPaused: boolean;
  currentIndex: number;
  progress: number;              // 0-100
  remainingTime: number;         // 毫秒
}
```

#### 组件接口

```typescript
interface SlideshowProps {
  images: ImageFile[];
  settings: SlideshowSettings;
  onSettingsChange: (settings: Partial<SlideshowSettings>) => void;
  onClose: () => void;
}

interface SlideshowControlsProps {
  state: SlideshowState;
  settings: SlideshowSettings;
  onPlay: () => void;
  onPause: () => void;
  onStop: () => void;
  onNext: () => void;
  onPrev: () => void;
  onOpenSettings: () => void;
}

interface SlideshowSettingsProps {
  settings: SlideshowSettings;
  onChange: (settings: Partial<SlideshowSettings>) => void;
}
```

#### 动画实现（Framer Motion）

```typescript
const transitions = {
  none: {
    initial: {},
    animate: {},
    exit: {}
  },
  
  fade: {
    initial: { opacity: 0 },
    animate: { opacity: 1 },
    exit: { opacity: 0 }
  },
  
  slide: {
    initial: { x: '100%', opacity: 0 },
    animate: { x: 0, opacity: 1 },
    exit: { x: '-100%', opacity: 0 }
  },
  
  zoom: {
    initial: { scale: 0.8, opacity: 0 },
    animate: { scale: 1, opacity: 1 },
    exit: { scale: 1.2, opacity: 0 }
  },
  
  flip: {
    initial: { rotateY: 90, opacity: 0 },
    animate: { rotateY: 0, opacity: 1 },
    exit: { rotateY: -90, opacity: 0 }
  }
};
```

#### 设置面板设计
使用 Radix Dialog 实现设置弹窗：

```
┌─────────────────────────────────┐
│  幻灯片设置                  [X] │
├─────────────────────────────────┤
│  播放时长: [━━●━━━━] 3 秒       │
│                                 │
│  转换动画: [淡入淡出 ▾]         │
│                                 │
│  动画时长: [━●━━━━━] 500ms      │
│                                 │
│  □ 循环播放                     │
│  □ 随机播放                     │
│  ☑ 自动全屏                     │
│  ☑ 显示信息                     │
│  ☑ 显示进度                     │
│                                 │
│         [取消]  [确定]          │
└─────────────────────────────────┘
```

---

## File System Access API 使用

### 核心 API 封装

```typescript
// hooks/useFileSystem.ts

export function useFileSystem() {
  // 打开文件夹选择对话框
  async function openFolder(): Promise<FileSystemDirectoryHandle | null> {
    try {
      const handle = await window.showDirectoryPicker({
        mode: 'read',
        startIn: 'pictures' // 从图片文件夹开始
      });
      return handle;
    } catch (err) {
      if (err.name === 'AbortError') {
        // 用户取消
        return null;
      }
      throw err;
    }
  }

  // 递归扫描文件夹
  async function scanFolder(
    dirHandle: FileSystemDirectoryHandle,
    path = ''
  ): Promise<{ folders: FolderNode[]; images: ImageFile[] }> {
    const folders: FolderNode[] = [];
    const images: ImageFile[] = [];

    for await (const entry of dirHandle.values()) {
      const entryPath = path ? `${path}/${entry.name}` : entry.name;

      if (entry.kind === 'directory') {
        const imageCount = await countImages(entry);
        folders.push({
          id: crypto.randomUUID(),
          name: entry.name,
          handle: entry,
          path: entryPath,
          children: [],
          imageCount,
          totalImageCount: imageCount,
          isExpanded: false,
          isLoaded: false,
          level: path.split('/').length
        });
      } else if (entry.kind === 'file') {
        if (isImageFile(entry.name)) {
          const file = await entry.getFile();
          images.push(await createImageFile(file, entry, entryPath));
        }
      }
    }

    return { folders, images };
  }

  // 判断是否为图片文件
  function isImageFile(filename: string): boolean {
    const imageExtensions = [
      '.jpg', '.jpeg', '.png', '.gif', 
      '.webp', '.bmp', '.svg', '.avif'
    ];
    const ext = filename.toLowerCase().slice(filename.lastIndexOf('.'));
    return imageExtensions.includes(ext);
  }

  // 创建图片文件对象
  async function createImageFile(
    file: File,
    handle: FileSystemFileHandle,
    path: string
  ): Promise<ImageFile> {
    const url = URL.createObjectURL(file);
    const dimensions = await getImageDimensions(url);

    return {
      id: crypto.randomUUID(),
      name: file.name,
      handle,
      path,
      blob: file,
      url,
      thumbnail: await createThumbnail(url, 300),
      size: file.size,
      width: dimensions.width,
      height: dimensions.height,
      type: file.type,
      createdAt: new Date(file.lastModified),
      modifiedAt: new Date(file.lastModified),
      folderPath: path.slice(0, path.lastIndexOf('/'))
    };
  }

  // 获取图片尺寸
  function getImageDimensions(url: string): Promise<{ width: number; height: number }> {
    return new Promise((resolve) => {
      const img = new Image();
      img.onload = () => resolve({ width: img.width, height: img.height });
      img.src = url;
    });
  }

  // 生成缩略图
  async function createThumbnail(url: string, maxSize: number): Promise<string> {
    return new Promise((resolve) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d')!;

        const scale = Math.min(maxSize / img.width, maxSize / img.height);
        canvas.width = img.width * scale;
        canvas.height = img.height * scale;

        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        resolve(canvas.toDataURL('image/jpeg', 0.8));
      };
      img.src = url;
    });
  }

  // 统计文件夹图片数量
  async function countImages(dirHandle: FileSystemDirectoryHandle): Promise<number> {
    let count = 0;
    for await (const entry of dirHandle.values()) {
      if (entry.kind === 'file' && isImageFile(entry.name)) {
        count++;
      }
    }
    return count;
  }

  return {
    openFolder,
    scanFolder,
    isImageFile,
    createImageFile
  };
}
```

### 浏览器兼容性

| 功能 | Chrome | Edge | Firefox | Safari |
|------|--------|------|---------|--------|
| File System Access API | ✅ 86+ | ✅ 86+ | ❌ | ❌ 15.2+ |
| showDirectoryPicker | ✅ | ✅ | ❌ | ❌ |

**降级方案**：
- 不支持的浏览器使用 `<input type="file" webkitdirectory>`
- 提示用户使用 Chrome/Edge 浏览器

---

## 整体页面布局

```
┌────────────────────────────────────────────────────────┐
│  📁 图片查看器                                    [设置] │
│  [打开文件夹] [视图: 网格 ▾] [排序: 名称 ▾] [☑ 递归]  │
├─────────────┬──────────────────────────────────────────┤
│             │                                          │
│  文件夹树    │         图片画廊                         │
│             │   ┌─────┬─────┬─────┬─────┐             │
│  📁 根目录   │   │ 🖼️  │ 🖼️  │ 🖼️  │ 🖼️  │             │
│  ├─ 📁 2023 │   └─────┴─────┴─────┴─────┘             │
│  │  ├─ 📁 01│   ┌─────┬─────┬─────┬─────┐             │
│  │  │  └─ 42│   │ 🖼️  │ 🖼️  │ 🖼️  │ 🖼️  │             │
│  │  └─ 📁 02│   └─────┴─────┴─────┴─────┘             │
│  └─ 📁 2024 │                                          │
│     └─ 📁 01│   共 156 张图片                          │
│             │   [🔍 搜索...]        [▶️ 幻灯片播放]    │
│             │                                          │
│  可调整宽度  │                                          │
│     ↔       │                                          │
└─────────────┴──────────────────────────────────────────┘
```

---

## 键盘快捷键

| 快捷键 | 功能 | 作用域 |
|--------|------|--------|
| `Ctrl/Cmd + O` | 打开文件夹 | 全局 |
| `Space` | 播放/暂停幻灯片 | 预览/幻灯片 |
| `F11` / `F` | 全屏切换 | 预览/幻灯片 |
| `Esc` | 关闭预览/退出全屏 | 预览/幻灯片 |
| `←` / `→` | 上一张/下一张 | 预览/幻灯片 |
| `↑` / `↓` | 上一个/下一个文件夹 | 文件夹树 |
| `Enter` | 展开/收起文件夹 | 文件夹树 |
| `+` / `=` | 放大 | 预览 |
| `-` | 缩小 | 预览 |
| `0` | 重置缩放 | 预览 |
| `R` | 旋转图片 | 预览 |
| `1` | 适应窗口 | 预览 |
| `2` | 实际大小 | 预览 |
| `Ctrl/Cmd + G` | 切换网格/列表视图 | 画廊 |
| `Ctrl/Cmd + F` | 搜索图片 | 画廊 |

---

## 性能优化策略

### 1. 图片加载优化
- **懒加载**：使用 Intersection Observer 只加载可见区域图片
- **缩略图**：Canvas 生成缩略图，减少内存占用
- **渐进式加载**：先显示低质量缩略图，再加载高清原图
- **预加载**：预览时提前加载前后 3 张图片

### 2. 虚拟滚动
```typescript
// 使用 react-window 或 react-virtual 实现
import { FixedSizeGrid } from 'react-window';

<FixedSizeGrid
  columnCount={4}
  columnWidth={300}
  height={800}
  rowCount={Math.ceil(images.length / 4)}
  rowHeight={300}
  width={1200}
>
  {({ columnIndex, rowIndex, style }) => {
    const index = rowIndex * 4 + columnIndex;
    const image = images[index];
    return <ImageCard key={image.id} image={image} style={style} />;
  }}
</FixedSizeGrid>
```

### 3. 缓存策略
```typescript
// 使用 IndexedDB 缓存缩略图
const thumbnailCache = new Map<string, string>();

async function getCachedThumbnail(imagePath: string): Promise<string | null> {
  // 先查内存缓存
  if (thumbnailCache.has(imagePath)) {
    return thumbnailCache.get(imagePath)!;
  }

  // 再查 IndexedDB
  const cached = await db.thumbnails.get(imagePath);
  if (cached) {
    thumbnailCache.set(imagePath, cached.data);
    return cached.data;
  }

  return null;
}

async function saveThumbnail(imagePath: string, thumbnail: string) {
  thumbnailCache.set(imagePath, thumbnail);
  await db.thumbnails.put({ path: imagePath, data: thumbnail });
}
```

### 4. 内存管理
```typescript
// 及时释放 Object URL
function cleanupImage(image: ImageFile) {
  if (image.url) {
    URL.revokeObjectURL(image.url);
  }
  if (image.thumbnail) {
    URL.revokeObjectURL(image.thumbnail);
  }
}

// 组件卸载时清理
useEffect(() => {
  return () => {
    images.forEach(cleanupImage);
  };
}, [images]);
```

---

## 状态管理

使用 React Context + Hooks 进行状态管理：

```typescript
// contexts/AppContext.tsx

interface AppState {
  // 文件系统
  rootFolder: FolderNode | null;
  selectedFolder: FolderNode | null;
  allImages: ImageFile[];
  filteredImages: ImageFile[];

  // 画廊设置
  gallerySettings: GallerySettings;

  // 预览状态
  viewerState: ImageViewerState;

  // 幻灯片状态
  slideshowState: SlideshowState;
  slideshowSettings: SlideshowSettings;

  // UI 状态
  isLoading: boolean;
  error: string | null;
}

interface AppActions {
  openFolder: () => Promise<void>;
  selectFolder: (folder: FolderNode) => void;
  toggleFolder: (folder: FolderNode) => void;
  updateGallerySettings: (settings: Partial<GallerySettings>) => void;
  openImageViewer: (image: ImageFile, index: number) => void;
  closeImageViewer: () => void;
  navigateImage: (direction: 'prev' | 'next') => void;
  startSlideshow: () => void;
  stopSlideshow: () => void;
  updateSlideshowSettings: (settings: Partial<SlideshowSettings>) => void;
}

const AppContext = createContext<AppState & AppActions>(null!);

export function AppProvider({ children }: { children: React.ReactNode }) {
  const [state, setState] = useState<AppState>(initialState);
  
  // ... 实现各种 actions
  
  return (
    <AppContext.Provider value={{ ...state, ...actions }}>
      {children}
    </AppContext.Provider>
  );
}

export const useApp = () => useContext(AppContext);
```

---

## 本地存储（持久化）

使用 localStorage 保存用户偏好设置：

```typescript
interface StoredPreferences {
  gallerySettings: GallerySettings;
  slideshowSettings: SlideshowSettings;
  lastOpenedFolder: string | null;  // 文件夹路径
  theme: 'light' | 'dark' | 'auto';
  language: 'zh-CN' | 'en-US';
}

// hooks/useLocalStorage.ts
export function useLocalStorage<T>(key: string, defaultValue: T) {
  const [value, setValue] = useState<T>(() => {
    try {
      const item = window.localStorage.getItem(key);
      return item ? JSON.parse(item) : defaultValue;
    } catch {
      return defaultValue;
    }
  });

  useEffect(() => {
    try {
      window.localStorage.setItem(key, JSON.stringify(value));
    } catch (error) {
      console.error('Failed to save to localStorage:', error);
    }
  }, [key, value]);

  return [value, setValue] as const;
}
```

---

## 构建和部署

### 开发模式
```bash
pnpm dev
# 访问 http://localhost:3000
```

### 生产构建
```bash
# 构建静态文件
pnpm build

# Next.js 13+ 导出静态站点
# next.config.js 配置：
# output: 'export'

# 构建产物在 out/ 目录
```

### 使用方式
```bash
# 方式 1: 直接打开 HTML 文件
file:///path/to/out/index.html

# 方式 2: 使用本地服务器
npx serve out

# 方式 3: 打包成桌面应用（可选）
# 使用 Tauri 等轻量级框架
```

---

## 未来扩展功能

### Phase 4 - 高级特性
- [ ] **图片编辑**：裁剪、旋转、滤镜
- [ ] **标签系统**：为图片添加标签和描述
- [ ] **收藏功能**：收藏喜欢的图片
- [ ] **导出功能**：导出选中图片到新文件夹
- [ ] **对比模式**：并排对比两张图片
- [ ] **元数据显示**：EXIF 信息（相机型号、拍摄参数等）
- [ ] **地图视图**：基于 GPS 信息在地图上显示
- [ ] **时间轴视图**：按时间轴浏览图片
- [ ] **人脸识别**：基于浏览器 API 的简单人脸检测
- [ ] **重复检测**：找出重复或相似图片
- [ ] **批量重命名**：批量修改文件名
- [ ] **打印功能**：打印图片或联系表

### 技术改进
- [ ] **PWA 支持**：离线可用，添加到主屏幕
- [ ] **国际化**：多语言支持（中文、英文）
- [ ] **主题系统**：亮色/暗色/自定义主题
- [ ] **无障碍优化**：完整的 ARIA 支持和键盘导航
- [ ] **性能监控**：集成 Web Vitals 监控
- [ ] **错误追踪**：Sentry 等错误追踪服务

---

## 技术债务和已知问题

1. **File System Access API 兼容性**
   - Firefox 和旧版 Safari 不支持
   - 需要提供降级方案

2. **大量图片性能**
   - 超过 1000 张图片时需要优化
   - 考虑分页或虚拟滚动

3. **内存泄漏风险**
   - Object URL 需要及时释放
   - 需要完善的清理机制

4. **移动端体验**
   - 触控手势支持需要完善
   - 响应式布局需要优化

---

## 测试策略

### 单元测试
```typescript
// 使用 Jest + React Testing Library
describe('FolderTree', () => {
  it('should render folder nodes', () => {
    // ...
  });

  it('should toggle folder expansion', () => {
    // ...
  });
});
```

### E2E 测试
```typescript
// 使用 Playwright
test('open folder and view images', async ({ page }) => {
  await page.goto('file:///path/to/index.html');
  await page.click('text=打开文件夹');
  // 模拟文件选择...
  await expect(page.locator('.image-card')).toHaveCount(10);
});
```

---

## 总结

本图片查看器采用现代 Web 技术栈，利用 File System Access API 实现本地文件访问，无需后端服务器。通过合理的架构设计和性能优化，提供流畅的用户体验。

**核心优势：**
- ✅ 纯前端应用，无需安装
- ✅ 直接通过浏览器访问本地文件
- ✅ 响应式设计，支持各种屏幕尺寸
- ✅ 丰富的功能和良好的用户体验
- ✅ 可扩展的架构，易于添加新功能

**适用场景：**
- 本地图片浏览和管理
- 摄影师作品集展示
- 设计稿预览和对比
- 家庭相册整理
